{% load custom_filters %}
{% load humanize %}
<article
    class="bg-transparent border-b border-[#2d3035] hover:bg-[#222529]/50 transition-colors duration-200 group px-4 py-4 md:px-6 md:py-6"
    id="article-{{ article.id }}">
    <div class="flex flex-col md:flex-row items-start gap-6">
        <!-- Desktop Image (Left Side - Hidden on Mobile) -->
        <div class="hidden md:block flex-shrink-0 mt-1 w-72">
            {% if article.image_url %}
            <div class="w-72 h-48 rounded-lg bg-cover bg-center shadow-sm border border-[#2d3035]"
                style="background-image: url('{{ article.image_url }}');"></div>
            {% else %}
            <div class="w-72 h-48 rounded-lg bg-[#2d3035] flex items-center justify-center text-4xl shadow-sm">
                {% if article.source.source_type == 'yt' %}üì∫{% elif article.source.source_type == 'podcast' %}üéôÔ∏è{%
                else %}üì∞{% endif %}
            </div>
            {% endif %}
        </div>

        <div class="flex-1 min-w-0 w-full">
            <!-- Header Meta -->
            <div class="flex items-center flex-wrap gap-x-2 gap-y-1 text-xs text-[#696d75] mb-2">
                <span class="font-bold text-slate-300">{{ article.source.name }}</span>

                {% if article.author %}
                <span>&middot;</span>
                <span class="text-[#696d75]">{{ article.author }}</span>
                {% endif %}

                <span>&middot;</span>
                <span class="text-[#696d75]">{{ article.pub_date|timesince }} ago</span>

                {% if article.duration_seconds %}
                <span>&middot;</span>
                <span class="inline-flex items-center gap-1 text-slate-400 bg-slate-800/50 px-2 py-0.5 rounded-full">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    {% load custom_filters %}{{ article.duration_seconds|format_duration }}
                </span>
                {% endif %}

                {% if article.view_count %}
                <span>&middot;</span>
                <span class="text-[#696d75]">{{ article.view_count|intcomma }} views</span>
                {% endif %}

                <!-- Content Depth Badge -->
                {% if article.content_depth %}
                <span>&middot;</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium
                    {% if article.content_depth == 'light' %}bg-green-500/10 text-green-400
                    {% elif article.content_depth == 'heavy' %}bg-purple-500/10 text-purple-400
                    {% else %}bg-blue-500/10 text-blue-400{% endif %}">
                    {% if article.content_depth == 'light' %}‚ö° Quick
                    {% elif article.content_depth == 'heavy' %}üìö Deep
                    {% else %}üìÑ Standard{% endif %}
                </span>
                {% endif %}
            </div>

            <!-- Title -->
            <h2 class="text-[17px] font-semibold text-slate-100 leading-snug mb-3">
                <a href="{{ article.link }}" target="_blank" rel="noopener noreferrer"
                    class="hover:underline decoration-indigo-500/50 underline-offset-2">
                    {{ article.title }}
                </a>
            </h2>

            <!-- Mobile Image (Between Title and Description - Hidden on Desktop) -->
            <div class="md:hidden mb-4 w-full">
                {% if article.image_url %}
                <div class="w-full h-48 rounded-lg bg-cover bg-center shadow-sm border border-[#2d3035]"
                    style="background-image: url('{{ article.image_url }}');"></div>
                {% else %}
                <div class="w-full h-48 rounded-lg bg-[#2d3035] flex items-center justify-center text-4xl shadow-sm">
                    {% if article.source.source_type == 'yt' %}üì∫{% elif article.source.source_type == 'podcast' %}üéôÔ∏è{%
                    else %}üì∞{% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Description (Flexible) -->
            <p class="text-[#9a9b9e] text-[15px] leading-relaxed mb-3">
                {{ article.description|striptags|truncatewords:100 }}
            </p>

            {% if article.ai_summary %}
            <div class="mb-4 bg-indigo-500/10 border border-indigo-500/20 rounded-md p-3">
                <div class="flex items-center gap-2 mb-1 text-indigo-400 text-xs font-bold uppercase tracking-wider">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2a1 1 0 011 1v1h1a1 1 0 010 2h-1v1a1 1 0 01-2 0V6H9a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 010 2h-1v1a1 1 0 01-2 0v-1H9a1 1 0 010-2h1v-1a1 1 0 011-1z" />
                    </svg>
                    AI Summary
                </div>
                <div class="text-sm text-indigo-200/80 prose prose-invert prose-sm">
                    {{ article.ai_summary|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Debug: Score Breakdown (Collapsible) -->
            {% if article.personalization_score > 0 %}
            <details class="mb-3 group/scores">
                <summary class="cursor-pointer text-xs text-[#696d75] hover:text-slate-400 flex items-center gap-2 select-none">
                    <svg class="w-3 h-3 transition-transform group-open/scores:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span>View score breakdown</span>
                </summary>
                <div class="mt-2 bg-slate-800/30 border border-slate-700/50 rounded-md p-3 space-y-2">
                    <!-- Relevance Score -->
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-400">AI Relevance</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all"
                                     style="width: {% widthratio article.relevance_score 100 100 %}%"></div>
                            </div>
                            <span class="font-mono {% if article.relevance_score >= 80 %}text-green-400{% elif article.relevance_score >= 60 %}text-blue-400{% elif article.relevance_score >= 40 %}text-yellow-400{% else %}text-gray-400{% endif %}">
                                {{ article.relevance_score }}
                            </span>
                        </div>
                    </div>

                    <!-- Personalization Score -->
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-400">Personalization</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 transition-all"
                                     style="width: {{ article.personalization_score|floatformat:0 }}%"></div>
                            </div>
                            <span class="font-mono {% if article.personalization_score >= 80 %}text-green-400{% elif article.personalization_score >= 60 %}text-blue-400{% elif article.personalization_score >= 40 %}text-yellow-400{% else %}text-gray-400{% endif %}">
                                {{ article.personalization_score|floatformat:0 }}
                            </span>
                        </div>
                    </div>

                    <!-- Trend Score -->
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-400">Trending</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-orange-500 to-orange-400 transition-all"
                                     style="width: {{ article.trend_score|floatformat:0 }}%"></div>
                            </div>
                            <span class="font-mono {% if article.trend_score >= 80 %}text-green-400{% elif article.trend_score >= 60 %}text-blue-400{% elif article.trend_score >= 40 %}text-yellow-400{% else %}text-gray-400{% endif %}">
                                {{ article.trend_score|floatformat:0 }}
                            </span>
                        </div>
                    </div>

                    <!-- Serendipity Score -->
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-400">Serendipity</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-purple-500 to-purple-400 transition-all"
                                     style="width: {{ article.serendipity_score|floatformat:0 }}%"></div>
                            </div>
                            <span class="font-mono {% if article.serendipity_score >= 80 %}text-green-400{% elif article.serendipity_score >= 60 %}text-blue-400{% elif article.serendipity_score >= 40 %}text-yellow-400{% else %}text-gray-400{% endif %}">
                                {{ article.serendipity_score|floatformat:0 }}
                            </span>
                        </div>
                    </div>
                </div>
            </details>
            {% endif %}

            <!-- Actions -->
            <div class="flex items-center gap-6 opacity-60 group-hover:opacity-100 transition-opacity">
                <!-- Feedback (Like/Dislike) -->
                {% include 'components/feedback_buttons.html' %}

                <!-- Separator -->
                <div class="h-4 w-px bg-[#2d3035]"></div>

                <!-- Mark as Read -->
                <button hx-post="{% url 'news:mark_read' article.id %}" hx-swap="outerHTML"
                    hx-target="#article-{{ article.id }}" title="Mark as read"
                    class="text-[#696d75] hover:text-green-500 hover:bg-green-500/10 p-1.5 rounded-full transition-colors flex items-center gap-1 group/btn">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>

                <!-- Internal Bookmark -->
                <button hx-post="{% url 'news:toggle_bookmark' article.id %}" hx-swap="outerHTML" title="Bookmark"
                    class="{% if article.is_saved %}text-yellow-500 bg-yellow-500/10{% else %}text-[#696d75] hover:text-yellow-500 hover:bg-yellow-500/10{% endif %} p-1.5 rounded-full transition-colors flex items-center gap-1">
                    <svg class="h-4 w-4" fill="{% if article.is_saved %}currentColor{% else %}none{% endif %}"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                </button>

                <!-- Export to Obsidian -->
                <button hx-post="{% url 'news:export_obsidian' article.id %}" hx-swap="outerHTML"
                    title="Export to Obsidian"
                    class="text-[#696d75] hover:text-white hover:bg-white/10 p-1.5 rounded-full transition-colors flex items-center gap-1">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</article>